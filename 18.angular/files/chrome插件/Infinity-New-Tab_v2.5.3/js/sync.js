_AJAX_login=false;_AJAX_img=false;_AJAX_register=false;AJAX_upSync=false;AJAX_downSync=false;AJAX_CHECK=false;$(document).ready(function(){recoveryFromCloud();$("#dataBackup").live("click",function(event){backupData()});$("#backupToCloud").live("click",function(event){localStorage.lastTime=0;syncToCloud()});$("#loginOrRegister").live("click",function(event){$("#bigLoginBox").fadeIn(100);$("#bigLoginBoxIn").show();if(isLogin()){$("#theLoginInput").hide();$("#theLogOut").show()}else{$("#theLoginInput").show();$("#theLogOut").hide();$("#login_email")[0].focus();try{var Obj=JSON.parse(localStorage.user);if(Obj.email){$("#login_email,#findEmail").val(Obj.email);$("#login_pw")[0].focus()}else{$("#login_email")[0].focus()}}catch(e){}}slideLock()});$("#bigLoginBox").live("click",function(event){$("#bigLoginBox").fadeOut(100);$("#bigLoginBoxIn").hide();slideUnLock()});$(".loginMenuItem").live("click",function(event){var i=$(this).index();$(".loginMenuItem").css("color","");$(this).css("color","#2ECC71");$(".loginContent").hide();$(".loginContent:nth-child("+(i+1)+")").show();$(".loginContent:nth-child("+(i+1)+")").find("input")[0].focus();$(".checkPoint").hide();if(_AJAX_img){_AJAX_img.abort()}_AJAX_img=$.ajax({url:"http://api.infinitynewtab.com/verify.php",dataType:"json",}).done(function(data){if(data.infinityType=="infinity"){$(".veriImg").attr({"src":data.img,"code":data.code})}})});$("#login_submit").live("click",function(event){onLogin()});$("#login_email,#login_pw").live("keydown",function(e){if(e.which==13){onLogin()}});$(".refreshImg").live("click",function(event){if(_AJAX_img){_AJAX_img.abort()}_AJAX_img=$.ajax({url:"http://api.infinitynewtab.com/verify.php",dataType:"json",}).done(function(data){if(data.infinityType=="infinity"){$(".veriImg").attr({"src":data.img,"code":data.code})}})});$(".veriCode").live("input",function(event){var v=$(this).val();var l=v.length;var md5_code=$(".veriImg").attr("code");if(l==4){if(md5_code==hex_md5(v)){$(".checkPoint").show().css("background-color","#2ECC71")}else{$(".checkPoint").show().css("background-color","#E74C3C")}}else{$(".checkPoint").hide()}});$("#Login_Cancel").live("click",function(event){cancelLogin()});$("#logout_submit").live("click",function(event){logout()});$("#registerSubmit").live("click",function(event){onregister()});$("#registerUsername,#registerPassword,#registerVerifyCode").live("keydown",function(e){if(e.which==13){onregister()}});$("#registerUsername").live("blur",function(event){var username=$(this).val();if(username!=""&&isEmail(username)){$.ajax({url:"http://api.infinitynewtab.com/checkName.php?name="+username,dataType:"json"}).done(function(data){if(data.infinityType=="infinity"){if(data.message=="1"){$("#registerNameCheck").show().css("background-color","#2ECC71")}else{if(data.message=="3"){$("#registerNameCheck").show().css("background-color","#E74C3C");$notification.show(i18n("UsernameAlreadyExists"))}}}})}else{if(!isEmail(username)){$("#registerNameCheck").show().css("background-color","#E74C3C")}}});$("#registerPassword").live("input",function(event){if($(this).val().length>0){$("#registerPasswordCheck").show()}else{$("#registerPasswordCheck").hide()}});$("#FindSubmit").live("click",function(event){var email=$("#findEmail").val();var code=$("#findVerifyCode").val();var md5_code=$(".veriImg").attr("code");if(email==""||code==""){$notification.show(i18n("emailCodenotEmpty"));return false}else{if(!isEmail(email)){$notification.show(i18n("emailInvalid"));return false}else{if(md5_code!=hex_md5(code)){$notification.show(i18n("VerifyCodeError"));return false}}}})});function onLogin(){var email=$("#login_email").val();var pw=$("#login_pw").val();var pw_md5=hex_md5(pw);if(email==""||pw==""){$notification.show(i18n("loginNoNull"));return false}else{if(!isEmail(email)){$notification.show(i18n("emailError"));return false}}$("#Login_hover").show();$loadingIn("#Login_hover_in");if(_AJAX_login){_AJAX_login.abort()}_AJAX_login=$.ajax({url:"http://api.infinitynewtab.com/login.php?name="+email+"&password="+pw_md5+"&version=2",dataType:"json",timeout:10000}).done(function(m){if(m.infinityType=="infinity"){if(m.message=="1"){loginSuccess(email,pw_md5)}else{if(m.message=="0"){$notification.show(i18n("UsernameOrPasswordWrong"));cancelLogin()}else{if(m.message=="8"){$notification.show(i18n("UsernameDoesNotExist"));cancelLogin()}}}}else{$notification.show(i18n("loginFailed"));cancelLogin()}}).fail(function(){$notification.show(i18n("newtworkError"));cancelLogin()})}function loginSuccess(email,pw_md5){try{$notification.show(i18n("LoginSuccess"),true);var Obj={"isLogin":true,"email":email,"password":pw_md5};localStorage.user=JSON.stringify(Obj);whenLogin(Obj);cancelLogin();$("#login_pw").val("");$("#theLoginInput").hide();$("#theLogOut").show();$("#bigLoginBox").fadeOut(100);$("#bigLoginBoxIn").hide();$.ajax({url:"http://api.infinitynewtab.com/checkBackup.php?username="+email+"&password="+pw_md5,dataType:"json"}).done(function(data){if(data.infinityType=="infinity"){var time=parseInt(data.backupTime);
if(time==0){firstSyncToCloud()}}})}catch(e){}}function logout(){try{var Obj=JSON.parse(localStorage.user);Obj.isLogin=false;var email=Obj.email;localStorage.user=JSON.stringify(Obj);$("#theLoginInput").show();$("#theLogOut").hide();whenUnlogin(Obj);$("#login_email,#findEmail").val(email)}catch(e){}}function cancelLogin(){try{$("#Login_hover").hide();_AJAX_login.abort();_AJAX_register.abort()}catch(e){}}function isLogin(){try{var user=JSON.parse(localStorage.user);if(user.isLogin){return true}else{return false}}catch(e){return false}}function isEmail(str){var reg=/^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/;return reg.test(str)}function onregister(){try{var username=$("#registerUsername").val();var password=$("#registerPassword").val();var verify=$("#registerVerifyCode").val();var md5_pw=hex_md5(password);var md5_code=$(".veriImg").attr("code");if(username==""||password==""||verify==""){$notification.show(i18n("registerNotNull"));return false}else{if(!isEmail(username)){$notification.show(i18n("emailError"));return false}else{if(md5_code!=hex_md5(verify)){$notification.show(i18n("VerifyCodeError"));return false}}}$("#Login_hover").show();$loadingIn("#Login_hover_in");if(_AJAX_register){_AJAX_register.abort()}_AJAX_register=$.ajax({url:"http://api.infinitynewtab.com/register.php?name="+username+"&password="+md5_pw+"&code="+verify+"&version=2",dataType:"json",timeout:10000}).done(function(data){if(data.infinityType=="infinity"){if(data.message=="1"){registerSuccess(username,md5_pw)}}else{$notification.show(i18n("RegistrationFailed"));cancelLogin()}}).fail(function(){$notification.show(i18n("newtworkError"));cancelLogin()})}catch(e){}}function registerSuccess(username,md5_pw){$notification.show(i18n("RegisterSuccessAndAutoLogin"),true);$("#loginOrRegister,#feedbackEmail").val(username);var Obj={"isLogin":true,"email":username,"password":md5_pw};localStorage.user=JSON.stringify(Obj);whenLogin(Obj);cancelLogin();$("#registerUsername").val("");$("#registerPassword").val("");$("#registerVerifyCode").val("");$("#login_pw").val("");$("#theLoginInput").hide();$("#theLogOut").show();$(".loginMenuItem").css("color","");$(".loginMenuItem:nth-child(1)").css("color","#2ECC71");$(".loginContent").hide();$(".loginContent:nth-child(1)").show();$("#bigLoginBox").fadeOut(100);$("#bigLoginBoxIn").hide()}function backupData(){var setting=encodeURIComponent(localStorage.setting);var main=encodeURIComponent(localStorage.main);var str='{"type":"theNew__INFINITY","setting":"'+setting+'","main":"'+main+'"}';var blob=new Blob([str]);var a=document.createElement("a");a.href=window.URL.createObjectURL(blob);a.download="infinityBackup.infinity";a.click();$(a).remove()}function firstSyncToCloud(){try{var username="";var password="";if(localStorage.user){var loginStatus=JSON.parse(localStorage.user);if(loginStatus.isLogin){username=loginStatus.email;password=loginStatus.password}else{return false}}else{return false}var setting=encodeURIComponent(localStorage.setting);var main=encodeURIComponent(localStorage.main);var str='{"type":"theNew__INFINITY","setting":"'+setting+'","main":"'+main+'"}';if(AJAX_upSync){AJAX_upSync.abort()}AJAX_upSync=$.ajax({url:"http://api.infinitynewtab.com/upSync.php",type:"POST",dataType:"json",data:{"username":username,"password":password,"json":str},}).done(function(data){if(data.infinityType=="infinity"&&data.message==2){localStorage.lastTime=data.backupTime;var myDate=new Date();localStorage.backupIn=myDate.getFullYear()+"/"+(myDate.getMonth()+1)+"/"+myDate.getDate()+" "+myDate.getHours()+":"+myDate.getMinutes()+":"+myDate.getSeconds()}$("#waiting").hide()}).fail(function(){console.log("error");$("#waiting").hide()})}catch(e){}}function syncToCloud(){try{var username="";var password="";if(localStorage.user){var loginStatus=JSON.parse(localStorage.user);if(loginStatus.isLogin){username=loginStatus.email;password=loginStatus.password}else{return false}}else{return false}var setting=encodeURIComponent(localStorage.setting);var main=encodeURIComponent(localStorage.main);var str='{"type":"theNew__INFINITY","setting":"'+setting+'","main":"'+main+'"}';if(AJAX_upSync){AJAX_upSync.abort()}AJAX_upSync=$.ajax({url:"http://api.infinitynewtab.com/upSync.php",type:"POST",dataType:"json",data:{"username":username,"password":password,"json":str},}).done(function(data){if(data.infinityType=="infinity"&&data.message==2){localStorage.lastTime=data.backupTime;var myDate=new Date();localStorage.backupIn=myDate.getFullYear()+"/"+(myDate.getMonth()+1)+"/"+myDate.getDate()+" "+myDate.getHours()+":"+myDate.getMinutes()+":"+myDate.getSeconds();$("#lastBackupAt").text(i18n("LastBackupAt")+localStorage.backupIn)}}).fail(function(){console.log("error")})}catch(e){}}function recoveryFromCloud(){$("#RecoveryFromCloud").live("click",function(event){try{$("#waiting").show();var username="";var password="";if(localStorage.user){var loginStatus=JSON.parse(localStorage.user);if(loginStatus.isLogin){username=loginStatus.email;password=loginStatus.password
}else{return false}}else{return false}$.ajax({url:"http://api.infinitynewtab.com/checkBackup.php?username="+username+"&password="+password,dataType:"json"}).done(function(data){if(data.infinityType=="infinity"){var time=parseInt(data.backupTime);if(time==0){firstSyncToCloud()}else{try{downSync(username,password,time,function(a){$("#waiting").hide();if(a){$notification.show(i18n("RecoveryDataSuccess"),true)}else{$notification.show(i18n("RecoveryDataFailed"))}})}catch(e){}}}}).fail(function(){$("#waiting").hide();$notification.show(i18n("RecoveryDataFailed"))})}catch(e){}})}function downSync(username,password,time,callback){try{if(AJAX_downSync){AJAX_downSync.abort()}AJAX_downSync=$.ajax({url:"http://api.infinitynewtab.com/downSync.php",type:"POST",data:{"username":username,"password":password},timeout:10000}).done(function(data){try{localStorage.lastTime=time;var obj=JSON.parse(data);var setting=decodeURIComponent(obj.setting);var main=decodeURIComponent(obj.main);recoveryTheData(setting,main);try{callback(true)}catch(e){console.log(e)}}catch(e){}}).fail(function(){try{callback(false)}catch(e){console.log(e)}})}catch(e){}}function recoveryTheData(setting,main){try{var mainObj=JSON.parse(main);localStorage.setting=setting;var ml=getBeforeml();var p=ml/(-1210);p=parseInt(Math.round(p));$setData.ini();loadTodos();loadNotes();$iconIni.load(mainObj);localStorage.main=main;$("#mainAll").css("x",ml+"px");$(".point").css("background-color","");$(".point:nth-child("+(p+1)+")").css("background-color",i18n("pointColor"));try{var showSearchBox=$setting.get("searchBox");var showSearchOption=$setting.get("searchType");var showBookmarkBar=$setting.get("bookmarksBar");var lastBg=$setting.get("lastWallpaper");var nowSearch=$setting.get("searchEngine");var Searchname=(nowSearch=="百度")?i18n("Baidu"):nowSearch;Searchname=(nowSearch=="Sogou")?i18n("Sogou"):nowSearch;$("#searchChange").attr("now",nowSearch).html(Searchname);if(lastBg.substring(0,15).indexOf("filesystem")>=0){var blur=$setting.get("blurWallpaper");if(blur){$setting.set("lastWallpaper","img/bgblur.jpg")}else{$setting.set("lastWallpaper","img/bg.jpg")}$("#bgOut").css("background-image","url("+$setting.get("lastWallpaper")+")");$setting.set("bgType","default");$setting.set("bgname","bg")}else{$("#bgOut").css("background-image","url("+lastBg+")")}if(!showSearchOption){$("#searchOption").hide()}else{$("#searchOption").show()}HowTpShowTop();$Setting.addTionalSearch();$mostVisited.ini()}catch(e){}setAllNotiNum()}catch(e){}}function recoveryTheDataMain(mainObj){try{var ml=getBeforeml();var p=ml/(-1210);p=parseInt(Math.round(p));$iconIni.load(mainObj);localStorage.main=JSON.stringify(mainObj);$("#mainAll").css("x",ml);$(".point").css("background-color","");$(".point:nth-child("+(p+1)+")").css("background-color",i18n("pointColor"))}catch(e){console.log(e)}}function getBeforeml(){try{var width,ml;width=$("#mainAll").css("width");width=parseInt(width);ml=$("#mainAll").css("x");ml=parseInt(ml);return ml}catch(e){}}function loadTodos(){var div="";var divfalse="";var todostrue=$setting.get("todostrue");var todosfalse=$setting.get("todosfalse");var l=todostrue.length;var lf=todosfalse.length;for(var i=0;i<l;i++){div+=('<div class="labelOut"><label class="checkLabel todoLabel checktodo"><input type="checkbox" class="checkbox">'+todostrue[i]+'</label><div class="toTop"></div></div>')}for(var i=0;i<lf;i++){divfalse+=('<div class="labelOut"><label class="checkLabel todoLabel checkdone"><input type="checkbox" checked="checked" class="checkbox">'+todosfalse[i]+'</label><div class="todoDelete"></div></div>')}$("#todoContent").html(div);$("#doneContent").html(divfalse)}function loadNotes(){var notes=$setting.get("notes");var menu="";for(var i=0;i<notes.length;i++){menu+='<div class="notesMenuItem"><span class="menuTitle">'+notes[i].title+'</span><img class="notesDelete" src="img/remove.png"></div>';if(i==0){$("#addNotesTitle").html(notes[0].text);$("#addNotesTitle").attr("menu","0")}}$(".notesMenu").html(menu);$(".notesMenuItem:nth-child(1)").css({"background-color":"#F39C12","color":"#fdfdfd"})};